

name: Docker Image scan via cli
on:
  push:
    branches:
      - master
  pull_request:
jobs:
  build:
    name: Docker Image scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      
      - name: Build an image from Dockerfile
        run: |
          docker build -t docker.io/sneha0302/docker-vulnerable-dvwa:${{ github.sha }} .
      
      - name: Run Trivy vulnerability scanner
      - run: |
          sudo apt-get install wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy
          trivy image -f sarif -o results.sarif docker.io/sneha0302/docker-vulnerable-dvwa:${{ github.sha }}
          
      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v1
        if: always() 
        with:
          sarif_file: 'trivy-results.sarif'
          
      - name: Archive Scan results
        uses: actions/upload-artifact@v2
        with:
          name: scan-report
          path: trivy-results.sarif          
