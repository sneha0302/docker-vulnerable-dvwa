trigger:
- master

pool:
  vmImage: ubuntu-latest

steps:
- script: echo Hello, world!
  displayName: 'Run a one-line script'

- script: docker build -t docker.io/sdevsecops221/docker-vulnerable-dvwa:$(Build.BuildNumber) .
  displayName: 'Build an image from Dockerfile'

- script: |
   curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.24.1
   trivy --version         
   trivy image --format sarif --output trivy-results.sarif --exit-code 0  docker.io/sdevsecops221/docker-vulnerable-dvwa:$(Build.BuildNumber)
  displayName: 'Run image scan using Trivy'


- task: PublishTestResults@2
  inputs:
    # Options: JUnit, NUnit, VSTest, xUnit, cTest
    testResultsFormat: 'JUnit' 
    testResultsFiles: 'trivy-results.sarif' 
    #searchFolder: '$(System.DefaultWorkingDirectory)' # Optional
    #mergeTestResults: false # Optional
    #failTaskOnFailedTests: false # Optional
    testRunTitle: 'Container Scan Results'
    #buildPlatform: # Optional
    #buildConfiguration: # Optional
    #publishRunAttachments: true # Optional

- task: PublishPipelineArtifact@1
  inputs:
    targetPath: 'trivy-results.sarif'
    artifactType: 'pipeline'
    artifactName: 'scan-results'
